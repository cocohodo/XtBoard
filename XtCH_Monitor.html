<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Xt Monitor</title>
  <style>
    .homeBtn{
      margin: 30px auto;
    }

    .tab-container {
      width: 100%;
      margin: 20px auto;
      margin-top: 30px;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #ccc;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-bottom: none;
      background-color: #f1f1f1;
      margin-right: 5px;
    }

    .tab.active {
      background-color: #fff;
      font-weight: bold;
      border-top: 2px solid #007bff;
      border-right: 1px solid #ccc;
      border-left: 1px solid #ccc;
    }

    .tab-content {
      display: none;
      border: 1px solid #ccc;
      padding: 15px;
      background-color: #fff;
      min-height: 750px;
    }

    .tab-content.active {
      display: block;
    }
    
    button {
      background-color: #e0e0e0;
      color: #333;
      border: 1px solid #bbb;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-right: 6px;
      margin-left: 6px;
    }
    
    button:hover {
      background-color: #d5d5d5;
    }
    
    button:active {
      background-color: #c0c0c0;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
    }
    
    button:disabled {
      background-color: #f2f2f2;
      color: #999;
      border-color: #ddd;
      cursor: not-allowed;
    }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
      font-size: 12px;
    }

    h2 {
      text-align: center;
    }

    table {
      width: 80%;
      margin: 20px auto;
      border-collapse: collapse;
      table-layout: fixed;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
      word-wrap: break-word;
    }

    th {
      background-color: #333;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 12px;
    }

    tbody tr:nth-child(even) {
      background-color: #f1f1f1;
    }

    #tableContainer {
      overflow-y: auto;
      display: flex;
      justify-content: center;
      max-height: 550px;
    }

    input, button {
      font-size: 12px;
      padding: 4px 8px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fff;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 500px;
      border-radius: 6px;
      font-size: 13px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: black;
    }
    .useInfo{
        color: red; 
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      opacity: 1;
      display: inline;
    }

    input[type=number] {
      -moz-appearance: textfield; /* Firefox에서 숫자 스핀 제거 방지 */
    }

    .status-accept { background-color: #c0eafd; color: #007acc; font-weight: bold; }
    .status-wait   { background-color: #fdf2ba; color: #d48806; font-weight: bold; }
    .status-prepare{ background-color: #f8b4cf; color: #c41d7f; font-weight: bold; }
    .status-full   { background-color: #fab4ae; color: #cf1322; font-weight: bold; }
    .status-down   { background-color: #d8d8d8; color: #8c8c8c; font-weight: bold; }
  </style>
</head>
<body>
<button onclick="goToPage('')" id="homeBtn">Home</button>
<div class="tab-container">
  <div class="tabs">
    <div class="tab active" onclick="showTab(0)">chdis</div>
    <div class="tab" onclick="showTab(1)">amdis</div>
    <div class="tab" onclick="showTab(2)">busdis</div>
    <div class="tab" onclick="showTab(3)">mdis</div>
    <div class="tab" onclick="showTab(4)">trdis</div>
    <div class="tab" onclick="showTab(5)">pushdis</div>
  </div>

  <div class="tab-content active">
    <h2>XtCH Monitor</h2>
  <!-- <input type="text" id="msg" placeholder="Type a message"> -->
  <div style="display: inline-flex; align-items: center;">
    <label for="intervalInput">요청 간격 : </label>
    <div style="position: relative; display: inline-block;">
      <input
      type="number"
      id="intervalInput"
      value="5"
      min="1"
      max="9999"
      step="1"
      oninput="limitDigits(this)"
      style="text-align: right; padding-right: 30px; width: 45px; margin-left: 6px;"
      >
      <span style="
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        color: #555;
        font-size: 12px;
      ">sec</span>
      </div>
    <button id="start_button" onclick="toggleRequest()">Send</button>
    <span id="search_sec">5초마다 조회 중</span>
  </div>
  <!-- <button id="start_button" onclick="toggleRequest()">Start</button> -->
   <div>
     <span>최종 수신 시간: </span>
     <span id="last_time"></span>
   </div>
  <div id="connect"></div>
  <button onclick="openModal()">사용설명</button>
  <span class="useInfo">*사용 전 확인</span>

  <div id="log_container">
    <div id="tableContainer">
      <table>
        <thead>
          <tr>
            <th>인덱스</th>
            <th>Accept-FD</th>
            <th>총 스레드 개수</th>
            <th>사용 스레드 개수</th>
            <th>Tr count</th>
            <th>프로세스 ID</th>
            <th>Runing count</th>
            <th>상태</th>
            <th>ResetFlag</th>
            <th>런타임</th>
          </tr>
        </thead>
        <tbody id="logTableBody"></tbody>
      </table>
    </div>
  </div>
  <div id="pagination" style="text-align: center; margin-top: 10px;"></div>

    <!-- 모달 팝업 -->
  <div id="helpModal" class="modal" >
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>📘 사용설명</h3>
      <ul>
        <li><b>초기 동작:</b> 페이지 열면 자동으로 조회가 시작됩니다. (5초 간격)</li>
        <br>
        <li><b>send:</b> 데이터 수신을 시작하거나 멈출 수 있습니다.</li>
        <b>		- 1 ~ 9999(단위 : 초) :</b> 해당 숫자(단위 : 초) 마다 데이터 수신합니다.
	      <br>
        <b>		- 0 (단위 : 초) :</b> 데이터 수신을 멈춥니다.
        <br>
	      <br>
        <li><b>최종 수신 시간:</b> 마지막으로 서버에서 데이터를 받은 시간입니다.</li>
        <br>
        <li><b>연결 상태:</b> 웹소켓 연결 상태를 보여줍니다 (Connected/Disconnected)</li>
      </ul>
    </div>
  </div>
  </div>
  <div class="tab-content">이곳은 <strong>탭 2</strong> 내용입니다.</div>
  <div class="tab-content">이곳은 <strong>탭 3</strong> 내용입니다.</div>
</div>

<script>
  let fullData = [];
    let currentPage = 1;
    const rowsPerPage = 20;

    const ws = new WebSocket("ws://211.240.28.240:30145/ms/");
    const last_time = document.getElementById("last_time");
    const connect = document.getElementById("connect");
    const logTable = document.getElementById("logTableBody");
    let liveRequest = false;
    let intervalId = null;
    
      ws.onopen = () => {
      connect.innerHTML = "<p><b>연결 상태 : Connected</b></p>";
      toggleRequest();
    };
	
    ws.onclose = () => {
      connect.innerHTML = "<p><b>연결 상태 : Disconnected</b></p>";
    };

    ws.onmessage = (event) => {
      const start_button = document.getElementById("start_button");
      const payloadArray = parseData(event.data);
      fullData = payloadArray;
      renderTablePage(1);
      last_time.innerText = new Date().toLocaleString();
    };

    function parseData(raw) {
      try {
        const obj = JSON.parse(raw);
        return obj.interval || [];
      } catch (e) {
        console.error("Invalid JSON:", raw);
        return [];
      }
    }

    function sendMessage() {
      // if (sendFlag) {
        const msg = document.getElementById("intervalInput").value;
        const json = { interval: msg };
        ws.send(JSON.stringify(json));
      // } else {
        // const json = { interval: "0" };
        // ws.send(JSON.stringify(json));
      // }
    }

    function toggleRequest() {
      const start_button = document.getElementById("start_button");
      const search_sec = document.getElementById("search_sec");
      const msg = document.getElementById("intervalInput").value;
      if (msg === "0") {
        // start_button.innerText = "Send";
        // sendMessage(false);
        search_sec.innerText = "현재 조회 중지 상태"
        // clearInterval(intervalId);
        // intervalId = null;
      } else {
        search_sec.innerText = msg + "초마다 조회 중"
        // start_button.innerText = "Stop";
        // intervalId = setInterval(sendMessage, 5000);
      }
      sendMessage();
      liveRequest = !liveRequest;
    }

    function goToPage(page) {
      const baseUrl = "/";
      window.location.href = baseUrl + page;
    }

    function openModal() {
      document.getElementById("helpModal").style.display = "block";
    }

    function closeModal() {
      document.getElementById("helpModal").style.display = "none";
    }

    window.addEventListener("keydown", function (e) {
      if (e.key === "Escape") closeModal();
    });

    window.onclick = function(event) {
      const modal = document.getElementById("helpModal");
      if (event.target === modal) closeModal();
    }

    function renderTablePage(page) {
      logTable.innerHTML = "";
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = fullData.slice(start, end);

      pageData.forEach(data => {
        const row = document.createElement("tr");
        const rowData = [
          data.id,
          data.PipeFd,
          data.ThreadCount,
          data.RunThreadCount,
          data.TotalTrCount,
          data.ProcessID,
          data.RunningCount,
          data.Status,
          data.ResetFlag,
          data.RunTime
        ];
        rowData.forEach((val, index) => {
          const cell = document.createElement("td");
          // Status 컬럼이면 변환
          if (index === 7) {
            const statusTextMap = {
              1: "ACCEPT",
              2: "WAIT",
              3: "PREPARE",
              4: "FULL",
              5: "DOWN"
            };

            const statusClassMap = {
              1: "status-accept",
              2: "status-wait",
              3: "status-prepare",
              4: "status-full",
              5: "status-down"
            };

            const statusText = statusTextMap[val] ?? "UNKNOWN";
            const statusClass = statusClassMap[val];

            cell.textContent = statusText;
            if (statusClass) {
              cell.classList.add(statusClass);
            }
          } else {
            cell.textContent = val ?? "-";
          }
          row.appendChild(cell);
        });
        logTable.appendChild(row);
      });

      currentPage = page;
      createPagination();
    }

    function createPagination() {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      const totalPages = Math.ceil(fullData.length / rowsPerPage);
      const maxButtons = 5;
	if(totalPages === 1){
          return;
      }

      const prevBtn = document.createElement("button");
      prevBtn.textContent = "이전";
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => renderTablePage(currentPage - 1);
      pagination.appendChild(prevBtn);

      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = startPage + maxButtons - 1;
      if (endPage > totalPages) {
        endPage = totalPages;
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.disabled = i === currentPage;
        btn.onclick = () => renderTablePage(i);
        pagination.appendChild(btn);
      }

      const nextBtn = document.createElement("button");
      nextBtn.textContent = "다음";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => renderTablePage(currentPage + 1);
      pagination.appendChild(nextBtn);
    }
// 더미 데이터 생성 후 테스트

    //  function generateDummyData(count) {
    //    const dummy = [];
    //    for (let i = 0; i < count; i++) {
    //      dummy.push({
    //        id: i + 1,
    //        PipeFd: Math.floor(Math.random() * 100),
    //        ThreadCount: Math.floor(Math.random() * 10 + 1),
    //        RunThreadCount: Math.floor(Math.random() * 10),
    //        TotalTrCount: Math.floor(Math.random() * 1000),
    //        ProcessID: Math.floor(Math.random() * 5000),
    //        RunningCount: Math.floor(Math.random() * 50),
    //        Status: i % 3 === 0 ? "Running" : "Idle",
    //        ResetFlag: i % 2,
    //        RunTime: `${Math.floor(Math.random() * 10)}h ${Math.floor(Math.random() * 60)}m`
    //      });
    //    }
    //    return dummy;
    //  }

    //  window.onload = () => {
    //    fullData = generateDummyData(500); // 150개 더미 데이터 생성
    //    renderTablePage(1); // 첫 페이지 렌더링
    //    last_time.innerText = new Date().toLocaleString();
    //    connect.innerHTML = "<p><b>연결 상태 : Dummy Data Mode</b></p>";
    //  };
    //  function limitDigits(input) {
    //     if (input.value.length > 4) {
    //       input.value = input.value.slice(0, 4);  // 최대 4자리까지만 입력 가능
    //     }
    //     if (parseInt(input.value) > 9999) {
    //       input.value = 9999;  // 값이 너무 크면 9999로 고정
    //     }
    //   }

    function limitDigits(input) {
      // 최대 4자리까지만 허용
      if (input.value.length > 4) {
        input.value = input.value.slice(0, 4);
      }
      // 최대값 보정
      if (parseInt(input.value) > 9999) {
        input.value = 9999;
      }
    }
    
  function showTab(index) {
    const tabs = document.querySelectorAll(".tab");
    const contents = document.querySelectorAll(".tab-content");

    tabs.forEach((tab, i) => {
      tab.classList.toggle("active", i === index);
      contents[i].classList.toggle("active", i === index);
    });
  }
</script>

</body>
</html>
