<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="./navbar.js" defer></script>
  <title>XtCH Monitor</title>
  <style>
   button {
      background-color: #e0e0e0;
      color: #333;
      border: 1px solid #bbb;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-right: 6px;
    }
    
    button:hover {
      background-color: #d5d5d5;
    }
    
    button:active {
      background-color: #c0c0c0;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
    }
    
    button:disabled {
      background-color: #f2f2f2;
      color: #999;
      border-color: #ddd;
      cursor: not-allowed;
    }


    body {
      font-family: Arial, sans-serif;
      display: flex;
      padding: 0;
      margin: 0;
      width: 100vw;
      height: 100%;
      background-color: #f9f9f9;
      font-size: 12px;
    }

    .layout {
      display: flex;
      height: 100%;
    }

    .content {
      flex: 1;
      background-color: #f9f9f9;
      padding: 1em;
      overflow-y: auto;
      padding-left: 50px;
      margin-left: 0; /* 기본값 */
      transition: margin-left 0.3s ease;
    }

    .content.fixed {
      margin-left: 20vw;
    }

    @media (max-width: 600px) {
      .content.fixed {
        margin-left: 60vw;
      }
    }

    my-navbar {
      width: 0;
      min-width: 0px; /* 작을 때를 위한 최소 너비 */
    }

    h2 {
      text-align: center;
    }

    table {
      width: 80%;
      margin: 20px auto;
      border-collapse: collapse;
      table-layout: fixed;
      max-height: 500px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
      word-wrap: break-word;
    }

    th {
      background-color: #333;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 12px;
    }

    tbody tr:nth-child(even) {
      background-color: #f1f1f1;
    }

    #tableContainer {
      max-height: 550px;
      overflow-y: auto;
      display: flex;
      justify-content: center;
    }

    input, button {
      font-size: 12px;
      padding: 4px 8px;
    }

    /* 모달 스타일 */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fff;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 500px;
      border-radius: 6px;
      font-size: 13px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: black;
    }
    .useInfo{
        color: red; 
    }
  </style>
</head>
<body>
  <div class="layout">
    <my-navbar></my-navbar>
    <div class="content">
      <button onclick="goToPage('')">Home</button>
      <h2>XtCH Monitor</h2>
      <input type="text" id="msg" placeholder="Type a message">
      <button id="start_button" onclick="toggleRequest()">Start</button>
      <span>최종 수신 시간: </span>
      <span id="last_time"></span>
      <div id="connect"></div>
      <button onclick="openModal()">사용설명</button>
      <span class="useInfo">*사용 전 확인</span>

      <div id="log_container">
        <div id="tableContainer">
          <table>
            <thead>
              <tr>
                <th>인덱스</th>
                <th>Accept-FD</th>
                <th>총 스레드 개수</th>
                <th>사용 스레드 개수</th>
                <th>Tr count</th>
                <th>프로세스 ID</th>
                <th>Runing count</th>
                <th>상태</th>
                <th>ResetFlag</th>
                <th>런타임</th>
              </tr>
            </thead>
            <tbody id="logTableBody">
            </tbody>
          </table>
        </div>
      </div>
      <div id="pagination" style="text-align: center; margin-top: 10px;"></div>
    </div>
  </div>
  <!-- 모달 팝업 -->
  <div id="helpModal" class="modal" >
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>📘 사용설명</h3>
      <ul>
        <li><b>초기 동작:</b> 페이지 열면 자동으로 조회가 시작됩니다. (5초 간격)</li>
        <br>
        <li><b>Start/Stop:</b> 데이터 수신을 시작하거나 멈출 수 있습니다.</li>
        <b>		- Stop:</b> 클릭시, 데이터 수신을 멈춥니다.
	<br>
        <b>		- Start:</b> 클릭시, 데이터 수신을 시작 후, 5초마다 데이터 수신합니다다.
        <br>
	 <br>
        <li><b>최종 수신 시간:</b> 마지막으로 서버에서 데이터를 받은 시간입니다.</li>
        <br>
        <li><b>연결 상태:</b> 웹소켓 연결 상태를 보여줍니다 (Connected/Disconnected)</li>
      </ul>
    </div>
  </div>
</body>

  <script>
    let fullData = [];
    let currentPage = 1;
    const rowsPerPage = 20;

    const ws = new WebSocket("ws://211.240.28.240:30145/ms/");
    const last_time = document.getElementById("last_time");
    const connect = document.getElementById("connect");
    const logTable = document.getElementById("logTableBody");
    let liveRequest = false;
    let intervalId = null;

    // ws.onopen = () => {
    //   connect.innerHTML = "<p><b>연결 상태 : Connected</b></p>";
    //   toggleRequest(); // 자동 시작
    //};
    ws.onclose = () => {
      connect.innerHTML = "<p><b>연결 상태 : Disconnected</b></p>";
    };
    // ws.onmessage = (event) => {
    //   logTable.innerHTML = "";
    //   const payloadArray = parseData(event.data);

    //   payloadArray.forEach(data => {
    //     const row = document.createElement("tr");
    //     const rowData = [
    //       data.id,
    //       data.PipeFd,
    //       data.ThreadCount,
    //       data.RunThreadCount,
    //       data.TotalTrCount,
    //       data.ProcessID,
    //       data.RunningCount,
    //       data.Status,
    //       data.ResetFlag,
    //       data.RunTime
    //     ];
    //     rowData.forEach(val => {
    //       const cell = document.createElement("td");
    //       cell.textContent = val ?? "-";
    //       row.appendChild(cell);
    //     });
    //     logTable.appendChild(row);
    //   });

    //   document.getElementById("tableContainer").scrollTop = document.getElementById("tableContainer").scrollHeight;
    //   last_time.innerText = new Date().toLocaleString();
    // };

    function parseData(raw) {
      try {
        const obj = JSON.parse(raw);
        return obj.payload || [];
      } catch (e) {
        console.error("Invalid JSON:", raw);
        return [];
      }
    }

    function sendMessage() {
      const msg = document.getElementById("msg").value;
      const json = { data: msg };
      ws.send(JSON.stringify(json));
    }

    function toggleRequest() {
      const start_button = document.getElementById("start_button");
      if (liveRequest) {
        start_button.innerText = "Start";
        clearInterval(intervalId);
        intervalId = null;
      } else {
        start_button.innerText = "Stop";
        sendMessage();
        intervalId = setInterval(sendMessage, 5000);
      }
      liveRequest = !liveRequest;
    }

    function goToPage(page) {
      const baseUrl = "./";
      window.location.href = baseUrl + page;
    }
    function toggleFixed() {
      window.navFixed = !window.navFixed;
      document.querySelector("my-navbar").updateFixedClass();
    }

    function openModal() {
      document.getElementById("helpModal").style.display = "block";
    }

    function closeModal() {
      document.getElementById("helpModal").style.display = "none";
    }

    // ESC 키로 모달 닫기
    window.addEventListener("keydown", function (e) {
      if (e.key === "Escape") closeModal();
    });

    // 모달 바깥 클릭 시 닫기
    window.onclick = function(event) {
      const modal = document.getElementById("helpModal");
      if (event.target === modal) closeModal();
    }
    function renderTablePage(page) {
      logTable.innerHTML = "";
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = fullData.slice(start, end);

      pageData.forEach(data => {
        const row = document.createElement("tr");
        const rowData = [
          data.id,
          data.PipeFd,
          data.ThreadCount,
          data.RunThreadCount,
          data.TotalTrCount,
          data.ProcessID,
          data.RunningCount,
          data.Status,
          data.ResetFlag,
          data.RunTime
        ];
        rowData.forEach(val => {
          const cell = document.createElement("td");
          cell.textContent = val ?? "-";
          row.appendChild(cell);
        });
        logTable.appendChild(row);
      });

      currentPage = page;
      createPagination();
    }

    function createPagination() {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      const totalPages = Math.ceil(fullData.length / rowsPerPage);
      const maxButtons = 5;
	if(totalPages === 1){
          return;
      }

      const prevBtn = document.createElement("button");
      prevBtn.textContent = "이전";
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => renderTablePage(currentPage - 1);
      pagination.appendChild(prevBtn);

      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = startPage + maxButtons - 1;
      if (endPage > totalPages) {
        endPage = totalPages;
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.disabled = i === currentPage;
        btn.onclick = () => renderTablePage(i);
        pagination.appendChild(btn);
      }

      const nextBtn = document.createElement("button");
      nextBtn.textContent = "다음";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => renderTablePage(currentPage + 1);
      pagination.appendChild(nextBtn);
    }
// 더미 데이터 생성 후 테스트
    function generateDummyData(count) {
       const dummy = [];
       for (let i = 0; i < count; i++) {
         dummy.push({
           id: i + 1,
           PipeFd: Math.floor(Math.random() * 100),
           ThreadCount: Math.floor(Math.random() * 10 + 1),
           RunThreadCount: Math.floor(Math.random() * 10),
           TotalTrCount: Math.floor(Math.random() * 1000),
           ProcessID: Math.floor(Math.random() * 5000),
           RunningCount: Math.floor(Math.random() * 50),
           Status: i % 3 === 0 ? "Running" : "Idle",
           ResetFlag: i % 2,
           RunTime: `${Math.floor(Math.random() * 10)}h ${Math.floor(Math.random() * 60)}m`
         });
       }
       return dummy;
     }

     window.onload = () => {
       fullData = generateDummyData(500); // 150개 더미 데이터 생성
       renderTablePage(1); // 첫 페이지 렌더링
       last_time.innerText = new Date().toLocaleString();
       connect.innerHTML = "<p><b>연결 상태 : Dummy Data Mode</b></p>";
     };
  </script>
</body>
</html>
